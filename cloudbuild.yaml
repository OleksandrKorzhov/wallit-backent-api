steps:
  # Build
  - name: gcr.io/cloud-builders/docker
    args: [
      'build',
      '-t',
      'us-central1-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/wallit-gql-discount-consumer-api:$SHORT_SHA',
      '-f',
      'Dockerfile.gql_service',
      '.'
    ]

  # Push to Artifact Registry
  - name: gcr.io/cloud-builders/docker
    args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/wallit-gql-discount-consumer-api:$SHORT_SHA']

  # Deploy to Cloud Run
  - name: gcr.io/cloud-builders/gcloud
    args: ['run', 'deploy', 'wallit-gql-discount-consumer-api-fcc0c24',
           '--image=us-central1-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/wallit-gql-discount-consumer-api:$SHORT_SHA',
           '--region', 'us-central1', '--platform', 'managed'
    ]

images:
  - us-central1-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/wallit-gql-discount-consumer-api:$SHORT_SHA